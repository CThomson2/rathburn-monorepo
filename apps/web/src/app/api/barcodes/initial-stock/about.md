# Server Side Barcode Generation for Initial Stock

## Overview

This is a server-side route that generates barcodes for existing drums in stock. It represents the first phase of our physical implementation plan for the new stock management system (database, barcode labels, etc.).

All existing drums have been recorded, organized, and uploaded to the Prisma database.

## Database Schema

The relevant table is `drums` with the following columns:

| Column         | Type                        | Nullable | Default                  |
| -------------- | --------------------------- | -------- | ------------------------ |
| id             | integer (primary key)       | no       | generated identity       |
| old_id         | integer                     | no       |                          |
| material       | text                        | no       | 'Unknown'::text          |
| batch_code     | text                        | yes      |                          |
| supplier       | text                        | yes      |                          |
| status         | text                        | no       | '''N''::text'::text      |
| created_at     | timestamp without time zone | no       | now()                    |
| updated_at     | character varying           | yes      | 'new'::character varying |
| site           | character varying           | no       | 'new'::character varying |
| date_ordered   | text                        | yes      |                          |
| chemical_group | text                        | yes      |                          |

**Indexes:** "drums_pkey" PRIMARY KEY, btree (id)

## Important Notes

- The `id` column is the primary key and is generated by the database
- The `old_id` column represents the drum ID from the legacy system
- For initial stock labels, we use the `old_id` to match drums to barcode labels
- Due to data quality issues, some `old_id` values are duplicated
- During processing, we check if an `old_id` has already been used in a barcode label
  - If it has, we skip it
  - If not, we generate a new barcode label

## Route Configuration

Mark this route as dynamic to handle request.url correctly

```ts
export const dynamic = "force-dynamic";
```

## PDF Label Configuration

The barcode label will be in exact same size and format as that used in the `api/barcodes/stock-drums/[order-detail-id]/route.ts` path

Label Size: 7.75 x 3.15 inches (converted to points in code)
Margin: 15 points (about 0.2 inches) to prevent content from being cut off

### Barcode

- Type: Code 128
- Position: Centered, at approximately 35% from bottom of page
- Size: 60% of page width, 75 points height
- Includes human-readable text

### QR Code

- Position: Right side of label
- Size: 80 points (or 70% of frame width if using frame)
- Contains URL to drum info page

### Text Elements

- Header: Company logo (140px width) or text at top
- Material name: Centered below header, 14pt bold
- Left column (from top, 20pt from left, 12pt font):
  - Manufacturer
  - PO Number
  - Product
  - Date
- Right column (from top, at page width/2, 12pt font):
  - Unit number (x/total)
  - Weight

### Images

- Company logo: Top left
- QR frame: Around QR code on right side

The PDF is generated with pdf-lib, barcodes with bwip-js, and QR codes with qrcode
